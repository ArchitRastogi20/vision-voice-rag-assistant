<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Modal RAG System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --accent-1: #802433;
            /* Sapienza Red */
            --accent-2: #a63041;
            --accent-3: #c94050;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(128, 36, 51, 0.15);
            --hover-glow: rgba(128, 36, 51, 0.15);
            --success: #15803d;
            --warning: #a16207;
            --error: #b91c1c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(128, 36, 51, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(128, 36, 51, 0.15) 0%, transparent 20%);
        }

        /* Header */
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--card-border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-1) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            border: 1px solid transparent;
        }

        .user-menu:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--card-border);
        }

        .user-badge {
            background: linear-gradient(135deg, var(--accent-1) 0%, var(--accent-2) 100%);
            color: white;
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(128, 36, 51, 0.3);
        }

        .username-text {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .dropdown-arrow {
            color: var(--text-secondary);
            font-size: 12px;
            transition: transform 0.2s;
        }

        .user-menu.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1e293b;
            border: 1px solid var(--card-border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 180px;
            display: none;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Main App Container */
        #appContainer {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgb(255, 255, 255);
            border-right: 1px solid var(--card-border);
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-2);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .upload-section {
            margin-bottom: 24px;
        }

        .upload-btn {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px dashed var(--text-secondary);
            margin-bottom: 12px;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: rgba(128, 36, 51, 0.1);
            border-color: var(--accent-1);
        }

        .doc-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .doc-item strong {
            display: block;
            color: var(--accent-1);
            margin-bottom: 4px;
        }

        .doc-item small {
            color: var(--text-secondary);
        }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 16px;
            line-height: 1.6;
            font-size: 15px;
            border: 1px solid var(--card-border);
        }

        .user-message .message-content {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }

        .assistant-message .message-content {
            background: rgba(128, 36, 51, 0.1);
            color: var(--text-primary);
            border-color: rgba(128, 36, 51, 0.2);
            border-bottom-left-radius: 4px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.2);
            border-radius: 6px;
            font-size: 13px;
            color: var(--warning);
            margin-top: 8px;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--warning);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .audio-player {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .replay-btn {
            width: auto;
            padding: 8px 16px;
            background: transparent;
            color: var(--accent-1);
            border: 1px solid var(--accent-1);
            font-size: 13px;
            border-radius: 8px;
        }

        .replay-btn:hover {
            background: rgba(128, 36, 51, 0.1);
        }

        /* Input Area */
        .input-area {
            border-top: 1px solid var(--card-border);
            padding: 20px 24px;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
        }

        .main-action-btn {
            background: linear-gradient(135deg, var(--accent-1) 0%, var(--accent-2) 100%);
            position: relative;
            width: 100%;
            color: white;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(128, 36, 51, 0.3);
            transition: all 0.3s;
        }

        .main-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(128, 36, 51, 0.4);
        }

        .main-action-btn.recording {
            background: var(--error);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            padding: 48px;
            text-align: center;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
            color: var(--accent-1);
        }

        .empty-state p {
            font-size: 15px;
            line-height: 1.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .status-msg {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .status-msg.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .home-button {
            position: fixed;
            top: 20px;
            left: 20px;
            text-decoration: none;
            background: var(--card-bg);
            padding: 12px 24px;
            border-radius: 12px;
            color: var(--text-primary);
            border: 1px solid var(--card-border);
            font-weight: 600;
            backdrop-filter: blur(12px);
            z-index: 1000;
            transition: all 0.3s;
        }

        .home-button:hover {
            background: var(--accent-1);
            color: white;
            border-color: var(--accent-1);
        }

        .header-container {
            position: relative;
            width: 100%;
            height: 70px;
            display: flex;
            align-items: center;
            background: transparent;
        }

        /* Left side */
        .header-left {
            width: 200px;
            /* or auto */
            display: flex;
            align-items: center;
            padding-left: 20px;
        }

        /* Centered title */
        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .header-center h1 {
            color: white;
            margin: 0;
            font-size: 24px;
        }

        /* Right side (optional) */
        .header-right {
            width: 200px;
        }

        .status-msg.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
    </style>
</head>

<body>
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Login Screen (Hidden) -->
    <div id="loginScreen" style="display: none;"></div>

    <!-- Main App -->
    <div id="appContainer">
        <!-- Header -->
        <div class="header">
            <div class="header-container">
                <div class="header-left">
                    <a href="http://localhost:8080" class="home-button" title="Back to Home">
                        <i data-feather="home"></i> Home
                    </a>
                </div>

                <div class="header-center">
                    <h1>Multi-Modal RAG</h1>
                </div>
            </div>

            <div class="user-info">
                <div class="user-menu" onclick="toggleDropdown()">
                    <div class="user-badge" id="userBadge">A</div>
                    <span class="username-text" id="usernameDisplay"></span>
                    <i data-feather="chevron-down" class="dropdown-arrow"></i>
                </div>
                <div class="dropdown-menu" id="dropdownMenu">
                    <!-- Logout removed for Auto-Login -->
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="upload-section">
                    <h3>Documents</h3>
                    <input type="file" id="pdfFile" accept=".pdf" style="display:none;">
                    <button class="upload-btn" onclick="document.getElementById('pdfFile').click()">
                        <i data-feather="file-plus"></i> Upload PDF
                    </button>
                    <div id="uploadStatus"></div>
                    <div id="documentsList"></div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <i data-feather="message-circle"
                            style="width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; color: var(--accent-1);"></i>
                        <p>Upload a PDF document and ask questions using your voice!</p>
                        <p style="margin-top:12px; font-size:13px;">Click the record button below to get started.</p>
                    </div>
                </div>

                <div class="input-area">
                    <button id="mainActionBtn" class="main-action-btn" onclick="handleMainAction()">
                        <i data-feather="mic"></i> Start Recording
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'http://localhost:8081/api';
        let sessionId = null;
        let username = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let hasConversation = false;

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('dropdownMenu');
            const userMenu = document.querySelector('.user-menu');

            if (!userMenu.contains(event.target)) {
                dropdown.classList.remove('show');
                userMenu.classList.remove('active');
            }
        });

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            const userMenu = document.querySelector('.user-menu');

            dropdown.classList.toggle('show');
            userMenu.classList.toggle('active');
        }

        // ============= AUTO-LOGIN =============
        function autoLogin() {
            // Check for user in URL params
            const urlParams = new URLSearchParams(window.location.search);
            const userFromUrl = urlParams.get('username');

            if (userFromUrl) {
                console.log('Logging in with username:', userFromUrl);
                login(userFromUrl);
            } else {
                // Determine if we should redirect or create a guest
                // For now, let's redirect to landing page if no user
                // window.location.href = 'http://localhost:8080';

                // Or fallback to guest
                const randomNum = Math.floor(Math.random() * 10000);
                const guestUser = `Guest_${randomNum}`;
                login(guestUser);
            }
        }

        async function login(usernameInput) {
            try {
                const formData = new FormData();
                formData.append('username', usernameInput);

                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    sessionId = data.session_id;
                    username = data.username;

                    // Show app
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    document.getElementById('usernameDisplay').textContent = username;
                    document.getElementById('userBadge').textContent = username.charAt(0).toUpperCase();

                    // Load documents and conversation history
                    await loadDocuments();
                    await loadConversationHistory();
                } else {
                    console.error('Auto-login failed:', data.detail);
                }
            } catch (error) {
                console.error('Auto-login error:', error);
            }
        }

        // Initialize on load
        window.onload = autoLogin;

        function showLoginStatus(message, type) {
            const statusDiv = document.getElementById('loginStatus');
            statusDiv.innerHTML = `<div class="status-msg ${type}">${message}</div>`;
        }

        // ============= LOGOUT =============
        async function logout() {
            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);

                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    body: formData
                });

                // Reset state
                sessionId = null;
                username = null;
                hasConversation = false;

                // Show login screen
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('username').value = '';

                // Clear chat
                document.getElementById('chatMessages').innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                        </svg>
                        <p>Upload a PDF document and ask questions using your voice!</p>
                    </div>
                `;
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // ============= CONVERSATION HISTORY =============
        async function loadConversationHistory() {
            try {
                const response = await fetch(`${API_BASE}/conversations?session_id=${sessionId}`);
                const data = await response.json();

                console.log('Loaded conversations:', data);

                if (data.conversations && data.conversations.length > 0) {
                    const chatDiv = document.getElementById('chatMessages');
                    chatDiv.innerHTML = '';

                    data.conversations.forEach(conv => {
                        addMessage('user', conv.query, false, null, false);
                        addMessage('assistant', conv.answer, false, conv.audio, false);
                    });

                    hasConversation = true;
                    updateMainButton();
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // ============= PDF UPLOAD =============
        document.getElementById('pdfFile').addEventListener('change', uploadPDF);

        async function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];

            if (!file) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="status-msg">Uploading and processing...</div>';

            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/upload-pdf`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = `<div class="status-msg success">‚úì ${data.filename} uploaded! (${data.num_chunks} chunks)</div>`;
                    fileInput.value = '';
                    loadDocuments();
                    setTimeout(() => statusDiv.innerHTML = '', 3000);
                } else {
                    statusDiv.innerHTML = `<div class="status-msg error">${data.detail || 'Upload failed'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-msg error">Error: ${error.message}</div>`;
            }
        }

        // ============= LOAD DOCUMENTS =============
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/documents?session_id=${sessionId}`);
                const data = await response.json();

                const listDiv = document.getElementById('documentsList');
                if (data.documents && data.documents.length > 0) {
                    listDiv.innerHTML = data.documents.map(doc => `
                        <div class="doc-item">
                            <strong>${doc.filename}</strong>
                            <small>Chunks: ${doc.num_chunks}</small>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<p style="color:#999; font-size:13px;">No documents yet</p>';
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        // ============= MAIN ACTION BUTTON =============
        function updateMainButton() {
            const btn = document.getElementById('mainActionBtn');
            if (isRecording) {
                btn.textContent = '‚èπÔ∏è Stop Recording';
                btn.className = 'main-action-btn recording';
            } else if (hasConversation) {
                btn.textContent = 'üé§ Ask Another Question';
                btn.className = 'main-action-btn idle';
            } else {
                btn.textContent = 'üé§ Start Recording';
                btn.className = 'main-action-btn';
            }
        }

        async function handleMainAction() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processVoiceQuery(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                updateMainButton();

                addMessage('user', 'Recording...', true, null, false);
            } catch (error) {
                alert(`Microphone error: ${error.message}`);
            }
        }

        async function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                updateMainButton();

                const btn = document.getElementById('mainActionBtn');
                btn.disabled = true;
            }
        }

        // ============= PROCESS VOICE QUERY =============
        async function processVoiceQuery(audioBlob) {
            const chatDiv = document.getElementById('chatMessages');

            // Remove "Recording..." message
            const recordingMsg = chatDiv.querySelector('.temp');
            if (recordingMsg) recordingMsg.remove();

            // Show processing status
            const statusId = addStatusMessage('üé§ Transcribing your voice...');

            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('audio', audioBlob, 'query.wav');

                updateStatusMessage(statusId, 'üîç Searching your documents...');

                const response = await fetch(`${API_BASE}/voice-query`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Voice query failed');
                }

                updateStatusMessage(statusId, 'ü§ñ Generating answer with AI...');

                const data = await response.json();

                removeStatusMessage(statusId);

                // Add user question
                addMessage('user', data.query, false, null, false);

                // Add AI answer with audio - AUTO-PLAY enabled
                addMessage('assistant', data.answer, false, data.audio, true);

                hasConversation = true;
                updateMainButton();

            } catch (error) {
                removeStatusMessage(statusId);
                addMessage('assistant', `Error: ${error.message}`, false, null, false);
            } finally {
                document.getElementById('mainActionBtn').disabled = false;
            }
        }

        // ============= MESSAGE HANDLING =============
        function addMessage(role, content, isTemp = false, audioBase64 = null, shouldAutoPlay = false) {
            const chatDiv = document.getElementById('chatMessages');

            // Remove empty state
            const emptyState = chatDiv.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message ${isTemp ? 'temp' : ''}`;

            const label = role === 'user' ? 'You' : 'Assistant';
            const audioId = `audio-${Date.now()}`;

            let html = `
                <div class="message-label">${label}</div>
                <div class="message-content">${content}</div>
            `;

            if (audioBase64) {
                const audioSrc = `data:audio/wav;base64,${audioBase64}`;
                html += `
                    <div class="audio-player">
                        <audio id="${audioId}" controls>
                            <source src="${audioSrc}" type="audio/wav">
                        </audio>
                        <button class="replay-btn" onclick="replayAudio('${audioId}')">
                            üîä Replay
                        </button>
                    </div>
                `;
            }

            messageDiv.innerHTML = html;
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            // Auto-play ONLY for new messages
            if (audioBase64 && shouldAutoPlay) {
                // Use requestAnimationFrame to ensure DOM is ready
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const audioEl = document.getElementById(audioId);
                        if (audioEl) {
                            console.log('Attempting to auto-play audio:', audioId);
                            const playPromise = audioEl.play();

                            if (playPromise !== undefined) {
                                playPromise
                                    .then(() => {
                                        console.log('‚úì Auto-play successful');
                                    })
                                    .catch(error => {
                                        console.log('‚úó Auto-play blocked by browser:', error.message);
                                        console.log('User can click the play button manually');
                                    });
                            }
                        } else {
                            console.error('Audio element not found:', audioId);
                        }
                    });
                });
            }

            return messageDiv;
        }

        function addStatusMessage(text) {
            const chatDiv = document.getElementById('chatMessages');
            const statusDiv = document.createElement('div');
            const id = `status-${Date.now()}`;
            statusDiv.id = id;
            statusDiv.className = 'message';
            statusDiv.innerHTML = `
                <div class="status-indicator">
                    <div class="spinner"></div>
                    <span>${text}</span>
                </div>
            `;
            chatDiv.appendChild(statusDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            return id;
        }

        function updateStatusMessage(id, text) {
            const statusDiv = document.getElementById(id);
            if (statusDiv) {
                statusDiv.querySelector('span').textContent = text;
            }
        }

        function removeStatusMessage(id) {
            const statusDiv = document.getElementById(id);
            if (statusDiv) statusDiv.remove();
        }

        function replayAudio(audioId) {
            const audio = document.getElementById(audioId);
            if (audio) {
                audio.currentTime = 0;
                audio.play();
            }
        }
    </script>
</body>

</html>